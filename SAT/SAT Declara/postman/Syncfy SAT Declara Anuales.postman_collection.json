{
	"info": {
		"_postman_id": "445dd0da-91da-4efb-89e1-a54260d0d275",
		"name": "Syncfy SAT Declara Anuales",
		"description": "# Introduction\nThis is a collection with all the minimum steps needed to implement the use case of SAT Declara anuales\n\n# Authentication\nThis collection is configured to use API Key and Token session\n\n# Error Codes\nYou can see the error codes and their menaning in the [official documentation](https://syncfy.com/w/es/sync/public/app/(section:docs/mx/sync/widget/codes)).",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Get users linked to an API key",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "47656199-ac63-4d69-a680-1b0fc989a3a1",
						"exec": [
							""
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "4c2664df-2a8d-4270-8076-28325a602689",
						"exec": [
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "api_key api_key={{syncfy_api_key}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "https://sync.paybook.com/v1/users",
					"protocol": "https",
					"host": [
						"sync",
						"paybook",
						"com"
					],
					"path": [
						"v1",
						"users"
					]
				}
			},
			"response": []
		},
		{
			"name": "Creates a new user",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "4d4cd1c0-05e5-4712-990c-ff3c7be3a726",
						"exec": [
							"var jsonData = JSON.parse(responseBody);",
							"if(jsonData.code === 200){",
							"    var jsonData = JSON.parse(responseBody);",
							"    user = jsonData.response;",
							"    pm.collectionVariables.set(\"syncfy_id_user\", user.id_user);",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "api_key api_key={{sync_api_key}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"name\" : \"{{syncfy_username}}\"\n}"
				},
				"url": {
					"raw": "https://sync.paybook.com/v1/users",
					"protocol": "https",
					"host": [
						"sync",
						"paybook",
						"com"
					],
					"path": [
						"v1",
						"users"
					]
				}
			},
			"response": []
		},
		{
			"name": "Inits session",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "101e042f-d530-4134-b508-66194cb7a905",
						"exec": [
							"var jsonData = JSON.parse(responseBody);",
							"if(jsonData.code === 200){",
							"    var jsonData = JSON.parse(responseBody);",
							"    session = jsonData.response;",
							"    pm.collectionVariables.set(\"syncfy_token\", session.token);",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "api_key api_key={{syncfy_api_key}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"disabled": true
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"id_user\" : \"{{syncfy_id_user}}\"\n}"
				},
				"url": {
					"raw": "https://sync.paybook.com/v1/sessions",
					"protocol": "https",
					"host": [
						"sync",
						"paybook",
						"com"
					],
					"path": [
						"v1",
						"sessions"
					]
				}
			},
			"response": []
		},
		{
			"name": "Create Credential for Sat Declara",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "e9241464-b9f8-4a4d-84c9-4bfad5a3a4e3",
						"exec": [
							"var jsonData = JSON.parse(responseBody);",
							"if(jsonData.code === 200){",
							"    var jsonData = JSON.parse(responseBody);",
							"    credential = jsonData.response;",
							"    pm.collectionVariables.set(\"syncfy_twofa_url\", credential.twofa);",
							"    pm.collectionVariables.set(\"id_credential\", credential.id_credential);",
							"    pm.collectionVariables.set(\"syncfy_status_url\", credential.status);",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "bearer",
					"bearer": [
						{
							"key": "token",
							"value": "{{syncfy_token}}",
							"type": "string"
						}
					]
				},
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n\t\"id_site\" : \"{{syncfy_id_sat_declara_site}}\",\n\t\"credentials\": {\n\t\t\"username\": \"{{sat_declara_username}}\", \n\t\t\"password\": \"{{sat_declara_password}}\"\n\t}, \n\t\"token\": \"{{syncfy_token}}\"\n}"
				},
				"url": {
					"raw": "https://sync.paybook.com/v1/credentials",
					"protocol": "https",
					"host": [
						"sync",
						"paybook",
						"com"
					],
					"path": [
						"v1",
						"credentials"
					]
				}
			},
			"response": []
		},
		{
			"name": "Check credentials sync status",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "7b877d58-9557-4419-bb23-7222db963e3c",
						"exec": [
							"",
							"",
							"var jsonData = JSON.parse(responseBody);",
							"tests[\"Checking credentials sync status\"] = jsonData.code === 200;",
							"",
							"if(tests[\"Checking credentials sync status\"]){",
							"    var jsonData = JSON.parse(responseBody);",
							"    status = jsonData.response;",
							"}//End of if",
							"",
							"",
							"",
							"",
							"",
							"",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{syncfy_status_url}}?token={{syncfy_token}}",
					"host": [
						"{{syncfy_status_url}}"
					],
					"query": [
						{
							"key": "token",
							"value": "{{syncfy_token}}"
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Send Twofa challenge",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "34546e80-055e-4e41-addb-a4d3f235649d",
						"exec": [
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "bearer",
					"bearer": [
						{
							"key": "token",
							"value": "{{syncfy_token}}",
							"type": "string"
						}
					]
				},
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"twofa\" :  {\n         \"customtoken\": \"<texto_de_imagen>\"\n    } \n}"
				},
				"url": {
					"raw": "{{syncfy_twofa_url}}",
					"host": [
						"{{syncfy_twofa_url}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get declaraciones from /transactions",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "a3c69cff-142f-479d-8d24-911177d6fe01",
						"exec": [
							"var jsonData = JSON.parse(responseBody);",
							"if(jsonData.code === 200){",
							"    var jsonData = JSON.parse(responseBody);",
							"    transaction = jsonData.response[0];",
							"    pm.collectionVariables.set(\"id_transaction\", transaction.id_transaction);",
							"    for (attachment of transaction.attachments) {",
							"        if(attachment.mime == 'application/pdf') {",
							"            pm.collectionVariables.set(\"url_attachment_pdf\", attachment.url);",
							"        }else if(attachment.mime == null) {",
							"            pm.collectionVariables.set(\"url_attachment_json\", attachment.url);",
							"        }",
							"    }",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "bearer",
					"bearer": [
						{
							"key": "token",
							"value": "{{syncfy_token}}",
							"type": "string"
						}
					]
				},
				"method": "GET",
				"header": [],
				"url": {
					"raw": "https://sync.paybook.com/v1/transactions?id_credential={{id_credential}}",
					"protocol": "https",
					"host": [
						"sync",
						"paybook",
						"com"
					],
					"path": [
						"v1",
						"transactions"
					],
					"query": [
						{
							"key": "id_credential",
							"value": "{{id_credential}}"
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Get declaraciones from /attachments",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "340f2028-b494-4f6b-bdc3-f1602fca01c3",
						"exec": [
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "bearer",
					"bearer": [
						{
							"key": "token",
							"value": "{{syncfy_token}}",
							"type": "string"
						}
					]
				},
				"method": "GET",
				"header": [],
				"url": {
					"raw": "https://api.syncfy.com/v1{{url_attachment_pdf}}",
					"protocol": "https",
					"host": [
						"api",
						"syncfy",
						"com"
					],
					"path": [
						"v1{{url_attachment_pdf}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get declaraciones from /attachments parsed to json",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "5437778f-3b23-4d5f-96e6-506945ef95ee",
						"exec": [
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "bearer",
					"bearer": [
						{
							"key": "token",
							"value": "{{syncfy_token}}",
							"type": "string"
						}
					]
				},
				"method": "GET",
				"header": [],
				"url": {
					"raw": "https://api.syncfy.com/v1{{url_attachment_json}}/",
					"protocol": "https",
					"host": [
						"api",
						"syncfy",
						"com"
					],
					"path": [
						"v1{{url_attachment_json}}",
						""
					]
				}
			},
			"response": []
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"id": "c63c90c7-a3df-4b50-ab59-696db7617665",
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"id": "611af3f5-a9d6-4369-812b-d3b8cf8e9ba7",
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	],
	"variable": [
		{
			"id": "5781f3f7-1d34-4f96-8bf9-34b661a16b3d",
			"key": "syncfy_api_key",
			"value": ""
		},
		{
			"id": "cc8472f3-9107-4ff5-a7f6-18db697f5ffa",
			"key": "syncfy_id_sat_declara_site",
			"value": "59aefe28056f29793a58c091"
		},
		{
			"id": "410343ae-229f-4b84-9eaa-1719ec645bf5",
			"key": "syncfy_username",
			"value": ""
		},
		{
			"id": "4dee42c2-bf72-4f9e-9262-48ca65a89254",
			"key": "syncfy_token",
			"value": ""
		},
		{
			"id": "8d6496dc-402b-4021-bfe9-b8bda3d99edd",
			"key": "syncfy_id_user",
			"value": ""
		},
		{
			"id": "8ec636f9-985f-4a60-90d1-5f3d2c8a2b96",
			"key": "sat_declara_username",
			"value": ""
		},
		{
			"id": "c4e15d20-d68d-486e-af48-186f4a7d735f",
			"key": "sat_declara_password",
			"value": ""
		},
		{
			"id": "5eeb36ae-286c-403e-9144-ec04110377bc",
			"key": "syncfy_status_url",
			"value": ""
		},
		{
			"id": "57818a06-f089-4b9a-b10b-2ca52cf95735",
			"key": "syncfy_twofa_url",
			"value": ""
		},
		{
			"id": "5209d95c-3569-4cfe-bbb3-129ae7addd06",
			"key": "id_credential",
			"value": ""
		},
		{
			"id": "1b5a9492-af85-48f8-a3cd-b668d2e49161",
			"key": "id_transaction",
			"value": ""
		},
		{
			"id": "65d474b1-f9f4-4181-8b6e-3c5b6fa51c41",
			"key": "id_attachment",
			"value": ""
		},
		{
			"id": "ff460740-f04c-424b-880f-366f58d4fabf",
			"key": "url_attachment_pdf",
			"value": ""
		},
		{
			"id": "f01ef36f-8201-46c7-b975-1438d9a02eb7",
			"key": "url_attachment_json",
			"value": ""
		}
	],
	"protocolProfileBehavior": {}
}